# Пример использования магнитных катушек с IntroSatLib

Этот пример демонстрирует работу с магнитными катушками с помощью библиотеки [IntroSatLib](https://github.com/Obu-IntroSat/IntroSatLib)

## Описание

Подключаем необходимые библиотеки: 
```cpp
#include <Wire.h> // Для работы с I2C
#include <CoilFlyWheel.h> // Для работы с магнитными катушками
#include <IS_Bluetooth.h> // для перехода в bootloader для загрузки прошивки по Bluetooth
```

Создаём объект для управления магнитными катушками, используя интерфейс I2C1 (`Wire`). Здесь `0x3A` - адрес катушек по умолчанию.
```cpp
CoilFlyWheel coil(Wire, 0x3A);
```
### Функция `setup()`
Инициализируем последовательный порт (`Serial`) на скорости 115200 бод с 8-битным словом и проверкой чётности(1 бит, проверка на <u>чётность</u>)
```cpp
Serial.begin(115200, SERIAL_8E1);
```
---
Инициализируем шину I2C. Использованием метода `begin()` без аргументов инициализирует шину в режиме мастер-устройства.
```cpp
Wire.begin();
```
---
Выводим сообщение о начале инициализации катушек.
```cpp
Serial.print("Initializing CoilFlyWheel");
```
Пробуем инициализировать катушки в цикле. 


```cpp
while (coil.Init())
{
    Serial.print(".");
}
```

Если инициализация завершится с ошибкой, метод `Init()` вернёт `1`, что соответствует значению `true`. В этом случае тело цикла `while` будет выполнено, в последовательный порт будет выведен символ `.`, и инициализация будет проведена повторно.

Когда инициализация пройдёт успешно, метод `Init()` вернёт `0`, что соответствует `false`. Тогда тело цикла не будет выполнятся, и исполнения программы продолжится.
<!-- @unflesh Надо как-то понятнее описать -->

---
### Функция `loop()`
В бесконечном цикле изменяются значения, подаваемые на катушки.

При каждом выполнении этой функции, выполняется цикл `for`:
```cpp
for (int i = -30000; i <= 30000; i += 5000) {
    // ...
}
```
Этот цикл изменяет значение переменной `i` от `-30000` до `30000` с шагом в `5000`. 

---
Внутри цикла значение `i` подаётся на катушки
```cpp
coil.NeedSpeed(i);
```

Значение `i` также выводится в `Serial`, чтобы можно было отслеживать изменение значения через монитор порта.
```cpp
Serial.print("CoilFlyWheel speed: ");
Serial.println(i);
```
---
После каждого изменения происходит проверка, не пришёл ли символ `b` в `Serial`. Это необходимо для корректной работы перепрошивки через Bluetooth-модуль.
```cpp
if (Serial.available()) 
    {
        if (Serial.read() == 'b') // Читаем 
        {
            enter_bootloader(); // Метод для перехода в режим загрузчика
        }
    }
```

Проверяем, не пришли ли новые данные в `Serial`
```cpp
if (Serial.available()) 
    {
        // ...
    }
```

> [!NOTE]
> Если новые данные есть, метод `available()` вернёт положительное число - количество принятых байт. При использовании в качестве булевого условия, любое число, отличное от нуля, соответствует значению `true`. 

Читаем один символ и сравниваем его с символом `b`. Если совпал - переходим в режим загрузчика.
```cpp
if (Serial.read() == 'b')
    {
        enter_bootloader();
    }
```
---
Ждём 1 секунду, чтобы значение менялось с задержкой.
<!-- @unflesh Тут бы дописать что-нибудь -->
```cpp
delay(1000);
```

## Как использовать

1. Подключите плату маховика с подключёнными катушками к материнской плате IntroSat через интерфейс I2C при помощи шлейфа MicroMatch.
2. Подключите провод питания 5В к плате маховика с материнской платы
<!-- @unflesh Фоточка -->
<p align="center">
    <img alt="Фото подключения маховика с катушками" src="" />
</p>

3. Загрузите этот скетч на плату.
4. Откройте монитор порта и наблюдайте за изменением значения, подаваемого на магнитные катушки
5. Для перехода в режим перепрошивки отправьте символ `b` через Serial.

>[!NOTE]
> Для более наглядной демонстрации можете поднести компас к катушке и наблюдать за изменением положения стрелки при изменении значения, подаваемого на катушки.

## Необходимое ПО и оборудование
- Материнская плата IntroSat
- Плата маховика IntroSat с магнитными катушками
- Arduino IDE версии 2.0 или выше
- Пакет плат **stm32duino** в Arduino IDE (ссылка для менеджера плат: `https://github.com/stm32duino/BoardManagerFiles/raw/main/package_stmicroelectronics_index.json`)
- Библиотека [IntroSatLib](https://github.com/Obu-IntroSat/IntroSatLib)

## Файл примера

[CoilFlyWheel.ino](./CoilFlyWheel.ino)